<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlignAI - Resume Tailoring Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-bg: #fefdfb;
            --color-surface: #f5ede6;
            --color-border: #d9c3b0;
            --color-text: #2d2416;
            --color-text-light: #8b7355;
            --color-primary: #C17B4A;
            --color-primary-light: #E5CDB8;
            --color-primary-dark: #d4b89e;
            --color-ai-bg: #f0e1d2;
            --color-user-bg: #8b7355;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(-45deg, #f5ede6, #E5CDB8, #f0e1d2, #d9c3b0);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: var(--color-text);
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* HEADER - Clean top nav */
        .header {
            height: 60px;
            border-bottom: 2px solid var(--color-primary-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
        }

        .logo img {
            width: 36px;
            height: 36px;
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--color-text);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .upload-btn, .new-chat-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--color-primary-light);
            border-radius: 8px;
            background: var(--color-bg);
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            color: var(--color-text);
        }

        .upload-btn:hover, .new-chat-btn:hover {
            background: var(--color-primary-light);
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(193, 123, 74, 0.2);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem 1rem;
            border: 2px solid var(--color-primary-light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .user-menu:hover {
            background: var(--color-surface);
            border-color: var(--color-primary);
        }

        .user-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 2px solid var(--color-primary-light);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            z-index: 1000;
        }

        .user-dropdown.active {
            display: block;
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--color-text);
            text-decoration: none;
        }

        .dropdown-item:hover {
            background: var(--color-primary-light);
        }

        .dropdown-item i {
            width: 20px;
            text-align: center;
        }

        .dropdown-divider {
            height: 1px;
            background: var(--color-border);
            margin: 0.5rem 0;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--color-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: white;
        }

        /* MAIN LAYOUT - Claude style */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            margin-top: 60px;
        }

        /* SIDEBAR - Collapsible history */
        .sidebar {
            width: 260px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-right: 2px solid var(--color-primary-light);
            display: flex;
            flex-direction: column;
            transition: margin-left 0.3s;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.05);
        }

        .sidebar.collapsed {
            margin-left: -260px;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
        }

        .sidebar-header h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-text-light);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .chat-history {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .history-item {
            padding: 0.75rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .history-item.active {
            background: var(--color-primary-light);
        }

        /* CHAT AREA - Main focus */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 1rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* MESSAGE BUBBLES - Claude style */
        .message {
            display: flex;
            gap: 1rem;
            max-width: 100%;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.1rem;
        }

        .message.ai-message .message-avatar {
            background: var(--color-primary);
            color: white;
        }

        .message.user-message .message-avatar {
            background: var(--color-user-bg);
            color: white;
        }

        .message-content {
            flex: 1;
            font-size: 0.9375rem;
            line-height: 1.7;
        }

        .message.ai-message .message-content {
            color: var(--color-text);
        }

        .message.user-message .message-content {
            color: var(--color-text);
        }

        .message-content p {
            margin-bottom: 1rem;
        }

        .message-content p:last-child {
            margin-bottom: 0;
        }

        .message-content ul, .message-content ol {
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        .message-content li {
            margin-bottom: 0.5rem;
        }

        .message-content strong {
            font-weight: 600;
        }

        .suggestion-box {
            background: rgba(245, 237, 230, 0.8);
            backdrop-filter: blur(5px);
            border: 2px solid var(--color-primary-light);
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .suggestion-box h4 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--color-primary);
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.5rem;
        }

        .suggestion-list {
            list-style: none;
            padding: 0;
            margin: 0;
            counter-reset: suggestion-counter;
        }

        .suggestion-list li {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            border-left: 3px solid var(--color-primary);
            transition: all 0.2s ease;
        }

        .suggestion-list li:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(4px);
        }

        .suggestion-list li:last-child {
            margin-bottom: 0;
        }

        .suggestion-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            background: var(--color-primary);
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }

        .suggestion-text {
            flex: 1;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--color-text);
        }

        .suggestion-text strong {
            color: var(--color-primary);
            font-weight: 600;
        }

        .suggestion-text code {
            background: rgba(193, 123, 74, 0.15);
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 0.85em;
        }

        /* Restored session notification */
        .restored-notification {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--color-primary), #a86835);
            color: white;
            padding: 0.75rem 1.25rem;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 20px rgba(193, 123, 74, 0.4);
            z-index: 1000;
            animation: slideUp 0.3s ease, fadeOut 0.3s ease 3.5s forwards;
        }

        .restored-notification i {
            font-size: 1rem;
        }

        .restored-notification span {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .restored-notification button {
            background: none;
            border: none;
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            opacity: 0.8;
            padding: 0 0.25rem;
            margin-left: 0.5rem;
        }

        .restored-notification button:hover {
            opacity: 1;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
        }

        /* LaTeX Result Display */
        .latex-result {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(245,237,230,0.95));
            border: 2px solid var(--color-primary);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 0.5rem 0;
        }

        .latex-result h3 {
            color: var(--color-primary);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .latex-result p {
            margin-bottom: 0.5rem;
        }

        .latex-result ul {
            margin: 0.5rem 0 1rem 1.5rem;
        }

        .latex-result li {
            margin-bottom: 0.25rem;
        }

        .download-section {
            display: flex;
            gap: 0.75rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }

        .download-btn, .view-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .download-btn {
            background: linear-gradient(135deg, var(--color-primary), #a86835);
            color: white;
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(193, 123, 74, 0.4);
        }

        .view-btn {
            background: rgba(255,255,255,0.9);
            color: var(--color-text);
            border: 2px solid var(--color-primary-light);
        }

        .view-btn:hover {
            background: var(--color-primary-light);
            border-color: var(--color-primary);
        }

        .hint {
            font-size: 0.85rem;
            color: var(--color-text-light);
            margin-top: 0.5rem;
        }

        .hint a {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: 500;
        }

        .hint a:hover {
            text-decoration: underline;
        }

        /* LaTeX Code Display */
        .latex-code-container {
            background: #1e1e1e;
            border-radius: 10px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: #2d2d2d;
            color: #ccc;
            font-size: 0.85rem;
        }

        .code-header button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.75rem;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 5px;
            color: #ccc;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .code-header button:hover {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .latex-code {
            margin: 0;
            padding: 1rem;
            max-height: 400px;
            overflow: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            color: #d4d4d4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .latex-code code {
            font-family: inherit;
        }

        /* Agent Tool Chips */
        .tool-chip {
            background: linear-gradient(135deg, rgba(193, 123, 74, 0.1), rgba(193, 123, 74, 0.2)) !important;
            border-color: var(--color-primary) !important;
        }

        .tool-chip:hover {
            background: linear-gradient(135deg, var(--color-primary), #a86835) !important;
            color: white !important;
        }

        .tool-chip.generate {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.2)) !important;
            border-color: #28a745 !important;
        }

        .tool-chip.generate:hover {
            background: linear-gradient(135deg, #28a745, #1e7e34) !important;
        }

        .tool-chip.full-pipeline {
            background: linear-gradient(135deg, var(--color-primary), #a86835) !important;
            color: white !important;
            font-weight: 600;
            padding: 0.75rem 1.5rem !important;
        }

        .tool-chip.full-pipeline:hover {
            transform: translateY(-3px) !important;
            box-shadow: 0 6px 20px rgba(193, 123, 74, 0.4) !important;
        }

        /* Agent Result Display */
        .agent-result, .pipeline-result {
            background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(245,237,230,0.95));
            border: 2px solid var(--color-primary-light);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 0.5rem 0;
        }

        .agent-result h3, .pipeline-result h3 {
            color: var(--color-primary);
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }

        .analysis-content, .strategy-content {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .analysis-content ul, .strategy-content ul, .strategy-content ol {
            margin: 0.5rem 0 0.5rem 1.5rem;
        }

        .analysis-content li, .strategy-content li {
            margin-bottom: 0.5rem;
        }

        .analysis-content a {
            color: var(--color-primary);
            text-decoration: none;
        }

        .analysis-content a:hover {
            text-decoration: underline;
        }

        .match-score {
            display: inline-block;
            background: linear-gradient(135deg, var(--color-primary), #a86835);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 1rem;
        }

        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .suggestion-chip {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--color-primary-light);
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .suggestion-chip:hover {
            background: var(--color-primary-light);
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(193, 123, 74, 0.3);
        }

        /* TYPING INDICATOR */
        .typing-indicator {
            display: none;
            gap: 1rem;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dots {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--color-text-light);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* INPUT AREA - Fixed at bottom */
        .input-area {
            border-top: 2px solid var(--color-primary-light);
            padding: 1.5rem 1rem;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.05);
        }

        .input-wrapper {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
            max-width: 900px;
            margin: 0 auto;
        }

        .input-box {
            flex: 1;
            position: relative;
        }

        #chatInput {
            width: 100%;
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 1rem 3rem 1rem 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            resize: none;
            max-height: 200px;
            outline: none;
            transition: all 0.2s;
        }

        #chatInput:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(193, 123, 74, 0.1);
        }

        .send-btn {
            position: absolute;
            right: 0.75rem;
            bottom: 0.75rem;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--color-primary);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            background: #a6673d;
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: var(--color-border);
            cursor: not-allowed;
        }

        .attach-btn {
            width: 42px;
            height: 42px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            background: var(--color-bg);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            color: var(--color-text-light);
            transition: all 0.2s;
        }

        .attach-btn:hover {
            background: var(--color-surface);
            color: var(--color-text);
        }

        /* WELCOME STATE */
        .welcome-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 2rem;
        }

        .welcome-icon {
            width: 80px;
            height: 80px;
            background: var(--color-primary-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--color-primary);
            margin-bottom: 1.5rem;
        }

        .welcome-title {
            font-size: 1.75rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        .welcome-subtitle {
            font-size: 1rem;
            color: var(--color-text-light);
            margin-bottom: 2rem;
            max-width: 500px;
        }

        .example-prompts {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            max-width: 700px;
            width: 100%;
        }

        .example-prompt {
            padding: 1.25rem;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--color-primary-light);
            border-radius: 12px;
            cursor: pointer;
            text-align: left;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .example-prompt:hover {
            background: var(--color-primary-light);
            border-color: var(--color-primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(193, 123, 74, 0.3);
        }

        .example-prompt-icon {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .example-prompt-text {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text);
        }

        /* FILE UPLOAD MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            border: 2px solid var(--color-primary-light);
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(193, 123, 74, 0.4);
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-modal {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: var(--color-text-light);
        }

        .close-modal:hover {
            background: var(--color-surface);
        }

        .modal-body {
            padding: 1.5rem;
        }

        .upload-zone {
            border: 2px dashed var(--color-border);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-zone:hover {
            border-color: var(--color-primary);
            background: var(--color-surface);
        }

        .upload-zone.drag-over {
            border-color: var(--color-primary);
            background: var(--color-primary-light);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--color-primary);
            margin-bottom: 1rem;
        }

        .file-preview {
            display: none;
            padding: 1rem;
            background: var(--color-surface);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .file-preview.active {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .file-icon {
            font-size: 2rem;
            color: var(--color-primary);
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            font-size: 0.9375rem;
        }

        .file-size {
            font-size: 0.8125rem;
            color: var(--color-text-light);
        }

        .remove-file {
            cursor: pointer;
            color: var(--color-text-light);
            padding: 0.5rem;
        }

        .remove-file:hover {
            color: #ef4444;
        }

        .jd-section {
            margin-top: 1.5rem;
        }

        .jd-section h4 {
            font-size: 0.9375rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
        }

        #jobDescriptionText {
            width: 100%;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            resize: vertical;
            min-height: 150px;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid var(--color-border);
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(193, 123, 74, 0.3);
        }

        .btn-primary:hover {
            background: #a6673d;
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(193, 123, 74, 0.4);
        }

        .btn-primary:disabled {
            background: var(--color-border);
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--color-surface);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: var(--color-border);
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-text-light);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 60px;
                height: calc(100vh - 60px);
                z-index: 50;
            }

            .example-prompts {
                grid-template-columns: 1fr;
            }

            .header-actions {
                gap: 0.5rem;
            }

            .logo-text {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <header class="header">
            <a href="index.html" class="logo">
            <img src="logo.png" alt="AlignAI">
                <span class="logo-text">AlignAI</span>
            </a>

        <div class="header-actions">
            <button class="upload-btn" onclick="openUploadModal()">
                <i class="fas fa-upload"></i>
                <span>Upload</span>
            </button>
            <button class="new-chat-btn" onclick="startNewChat()">
                <i class="fas fa-plus"></i>
                <span>New Chat</span>
            </button>
            <div class="user-menu" onclick="toggleUserMenu(event)">
                    <div class="user-avatar" id="userAvatar">?</div>
                <span id="userName">User</span>
                <i class="fas fa-chevron-down" style="font-size: 0.75rem; color: var(--color-text-light);"></i>
                
                <div class="user-dropdown" id="userDropdown">
                    <div class="dropdown-item" onclick="event.stopPropagation(); window.location.href='index.html'">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="event.stopPropagation(); clearSession()">
                        <i class="fas fa-trash-alt"></i>
                        <span>Clear History</span>
                    </div>
                    <div class="dropdown-divider"></div>
                    <div class="dropdown-item" onclick="event.stopPropagation(); logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTAINER -->
    <div class="main-container">
        <!-- SIDEBAR (Optional - can be collapsed) -->
        <aside class="sidebar collapsed" id="sidebar">
            <div class="sidebar-header">
                <h3>Chat History</h3>
            </div>
            <div class="chat-history" id="chatHistory">
                <!-- Chat history items will be added here -->
            </div>
        </aside>

        <!-- CHAT AREA -->
        <div class="chat-area">
            <!-- WELCOME STATE (shown initially) -->
            <div class="welcome-state" id="welcomeState">
                <div class="welcome-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <h1 class="welcome-title">Welcome to AlignAI</h1>
                <p class="welcome-subtitle">
                    Upload your resume and job description to get started with AI-powered resume tailoring using RAG technology
                </p>

                <div class="example-prompts">
                    <div class="example-prompt" onclick="useExample('Analyze my resume against this job description')">
                        <div class="example-prompt-icon">üîç</div>
                        <div class="example-prompt-text">Analyze my resume against this job description</div>
                    </div>
                    <div class="example-prompt" onclick="useExample('Emphasize my Python and ML skills')">
                        <div class="example-prompt-icon">‚ú®</div>
                        <div class="example-prompt-text">Emphasize my Python and ML skills</div>
                    </div>
                    <div class="example-prompt" onclick="useExample('Add quantifiable metrics to my achievements')">
                        <div class="example-prompt-icon">üìä</div>
                        <div class="example-prompt-text">Add quantifiable metrics to my achievements</div>
                    </div>
                    <div class="example-prompt" onclick="useExample('Generate a tailored resume for this role')">
                        <div class="example-prompt-icon">üìÑ</div>
                        <div class="example-prompt-text">Generate a tailored resume for this role</div>
                    </div>
                </div>
            </div>

            <!-- MESSAGES CONTAINER -->
            <div class="messages-container" id="messagesContainer" style="display: none;">
                <!-- Messages will be added here -->
                
                <!-- Typing Indicator -->
                <div class="typing-indicator" id="typingIndicator">
                    <div class="message-avatar" style="background: var(--color-primary); color: white;">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="typing-dots">
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                        <span class="typing-dot"></span>
                    </div>
                </div>
            </div>

            <!-- INPUT AREA -->
            <div class="input-area">
                <div class="input-wrapper">
                    <button class="attach-btn" onclick="openUploadModal()">
                        <i class="fas fa-paperclip"></i>
                            </button>
                    <div class="input-box">
                        <textarea 
                            id="chatInput" 
                            placeholder="Message AlignAI..."
                            rows="1"
                            onkeypress="handleKeyPress(event)"
                            oninput="adjustTextareaHeight(); updateSendButton();"></textarea>
                        <button class="send-btn" id="sendBtn" onclick="sendMessage()" disabled>
                            <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
    </div>

    <!-- UPLOAD MODAL -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Upload Resume & Job Description</h3>
                <button class="close-modal" onclick="closeUploadModal()">
                    <i class="fas fa-times"></i>
                        </button>
                    </div>
            <div class="modal-body">
                <!-- Resume Upload -->
                <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                    <p style="font-weight: 600; margin-bottom: 0.5rem;">Upload your resume</p>
                    <p style="font-size: 0.875rem; color: var(--color-text-light);">
                        Drag & drop or click to browse ‚Ä¢ PDF or DOCX ‚Ä¢ Max 10MB
                    </p>
                    </div>
                <input type="file" id="fileInput" accept=".pdf,.docx" style="display: none;" onchange="handleFileSelect(event)">

                <!-- File Preview -->
                    <div class="file-preview" id="filePreview">
                            <div class="file-icon">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                    <div class="file-info">
                                <div class="file-name" id="fileName">Resume.pdf</div>
                                <div class="file-size" id="fileSize">2.5 MB</div>
                            </div>
                    <button class="remove-file" onclick="removeFile()">
                        <i class="fas fa-times"></i>
                            </button>
                </div>

                <!-- Job Description -->
                <div class="jd-section">
                    <h4>Job Description (Optional)</h4>
                    <textarea 
                        id="jobDescriptionText" 
                        placeholder="Paste the job description here for better analysis..."
                    ></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeUploadModal()">Cancel</button>
                <button class="btn btn-primary" id="analyzeBtn" onclick="analyzeWithRAG()" disabled>
                    <i class="fas fa-brain"></i> Analyze with RAG
                        </button>
                    </div>
                </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'http://localhost:5000/api';
        const STORAGE_KEY = 'alignai_session';
        
        // State
        let currentUser = null;
        let currentResume = null;
        let currentFile = null;
        let messageCount = 0;
        let chatHistory = [];

        // ==========================================
        // LOCAL STORAGE - Persistence like ChatGPT
        // ==========================================
        
        function saveToStorage() {
            const data = {
                resume: currentResume,
                fileName: currentFile ? currentFile.name : null,
                chatHistory: chatHistory,
                timestamp: Date.now()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            console.log('üíæ Session saved to localStorage');
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return false;
                
                const data = JSON.parse(saved);
                
                // Check if data is less than 7 days old
                const weekInMs = 7 * 24 * 60 * 60 * 1000;
                if (Date.now() - data.timestamp > weekInMs) {
                    console.log('‚è∞ Session expired, clearing...');
                    clearStorage();
                    return false;
                }
                
                // Restore resume
                if (data.resume) {
                    currentResume = data.resume;
                    if (data.fileName) {
                        currentFile = { name: data.fileName };
                    }
                    console.log('üìÑ Resume restored:', data.fileName);
                    
                    // Auto re-ingest resume into RAG system (rebuild vector store)
                    setTimeout(() => {
                        reIngestResume();
                    }, 1000);
                }
                
                // Restore chat history
                if (data.chatHistory && data.chatHistory.length > 0) {
                    chatHistory = data.chatHistory;
                    restoreChatHistory();
                    console.log('üí¨ Chat history restored:', chatHistory.length, 'messages');
                    return true;
                }
                
                return false;
            } catch (error) {
                console.error('Error loading from storage:', error);
                return false;
            }
        }

        // Re-ingest resume into RAG system after page refresh
        async function reIngestResume() {
            if (!currentResume || !currentResume.text) {
                console.log('‚ö†Ô∏è No resume to re-ingest');
                return;
            }
            
            console.log('üîÑ Re-ingesting resume into RAG system...');
            
            try {
                const response = await fetch(`${API_URL}/rag/analyze`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_text: currentResume.text,
                        job_description: currentResume.jobDescription || ''
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('‚úÖ RAG system ready! Vector store rebuilt.');
                    showNotification('‚úÖ RAG ready! You can use the suggestion buttons.', 'success');
                } else {
                    console.warn('‚ö†Ô∏è RAG re-ingest failed:', data.error);
                    showNotification('‚ö†Ô∏è RAG setup failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('‚ùå RAG re-ingest error:', error);
                showNotification('‚ùå Server error. Is the backend running?', 'error');
            }
        }

        function restoreChatHistory() {
            const container = document.getElementById('messagesContainer');
            container.style.display = 'flex';
            showWelcome(false);
            
            chatHistory.forEach(msg => {
                addMessageToDOM(msg.type, msg.content, false); // Don't save again
            });
        }

        function clearStorage() {
            localStorage.removeItem(STORAGE_KEY);
            console.log('üóëÔ∏è Session cleared');
        }

        function clearSession() {
            if (confirm('Clear all saved data? This will remove your resume and chat history.')) {
                clearStorage();
                currentResume = null;
                currentFile = null;
                chatHistory = [];
                messageCount = 0;
                document.getElementById('messagesContainer').innerHTML = '<div class="typing-indicator" id="typingIndicator"><div class="message-avatar" style="background: var(--color-primary); color: white;"><i class="fas fa-robot"></i></div><div class="typing-dots"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div></div>';
                showWelcome(true);
                alert('‚úÖ Session cleared successfully!');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            adjustTextareaHeight();
            
            // Debug: Check what's in localStorage
            const savedData = localStorage.getItem(STORAGE_KEY);
            console.log('üì¶ LocalStorage check:', savedData ? 'Data found!' : 'Empty - upload a resume first');
            if (savedData) {
                const parsed = JSON.parse(savedData);
                console.log('üìÑ Saved resume:', parsed.resume ? `${parsed.fileName} (${parsed.resume.text?.length || 0} chars)` : 'None');
                console.log('üí¨ Saved messages:', parsed.chatHistory?.length || 0);
            }
            
            // Load saved session
            const hasHistory = loadFromStorage();
            if (hasHistory) {
                // Show notification that session was restored
                setTimeout(() => {
                    showRestoredNotification();
                }, 500);
            } else if (!savedData) {
                console.log('üëÜ Upload a resume to enable persistence');
            }
        });

        function showRestoredNotification() {
            const notification = document.createElement('div');
            notification.className = 'restored-notification';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                <span>Previous session restored - rebuilding RAG...</span>
                <button onclick="this.parentElement.remove()">√ó</button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'restored-notification';
            notification.style.background = type === 'error' ? '#dc3545' : 
                                           type === 'success' ? '#28a745' : 
                                           'linear-gradient(135deg, var(--color-primary), #a86835)';
            notification.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-circle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()">√ó</button>
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 5000);
        }

        // Auth - allows demo mode without login
        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/auth/check-session`, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.authenticated && data.user) {
                    currentUser = data.user;
                    displayUser(data.user);
                } else {
                    // Demo mode - don't redirect, just use default user
                    currentUser = { id: 'demo', full_name: 'Demo User', email: 'demo@alignai.com' };
                    displayUser(currentUser);
                    console.log('Running in demo mode - some features may be limited');
                }
            } catch (error) {
                console.error('Auth error:', error);
                // Fallback to demo mode
                currentUser = { id: 'demo', full_name: 'Demo User', email: 'demo@alignai.com' };
                displayUser(currentUser);
            }
        }

        function displayUser(user) {
            const name = user.full_name || 'User';
            document.getElementById('userName').textContent = name.split(' ')[0];
            const initials = name.split(' ').map(n => n[0]).join('').toUpperCase() || 'U';
            document.getElementById('userAvatar').textContent = initials;
        }

        function toggleUserMenu(event) {
            event.stopPropagation();
            const dropdown = document.getElementById('userDropdown');
            dropdown.classList.toggle('active');
        }

        async function logout() {
            try {
                await fetch(`${API_URL}/auth/logout`, {
                    method: 'POST',
                    credentials: 'include'
                });
            } catch (error) {
                console.error('Logout error:', error);
            }
            window.location.href = 'index.html';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            const dropdown = document.getElementById('userDropdown');
            const userMenu = document.querySelector('.user-menu');
            if (dropdown && !userMenu.contains(event.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Modal
        function openUploadModal() {
            document.getElementById('uploadModal').classList.add('active');
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('active');
        }

        // File Upload
        const uploadZone = document.getElementById('uploadZone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, (e) => {
            e.preventDefault();
            e.stopPropagation();
            });
        });

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => {
                uploadZone.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => {
                uploadZone.classList.remove('drag-over');
            });
        });

        uploadZone.addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        async function handleFile(file) {
            const validTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload a PDF or DOCX file.');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                alert('File size must be less than 10MB.');
                return;
            }

            currentFile = file;
            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('filePreview').classList.add('active');

            const fileIcon = document.querySelector('.file-icon i');
            fileIcon.className = file.type === 'application/pdf' ? 'fas fa-file-pdf' : 'fas fa-file-word';
            
            // Disable button while uploading
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = true;
            analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            
            // Upload to backend and wait for completion
            await uploadResume(file);
            
            // Enable button after upload completes
            if (currentResume && currentResume.text) {
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = '<i class="fas fa-brain"></i> Analyze with RAG';
            } else {
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = 'Upload Failed';
                alert('Failed to upload resume. Please try again.');
            }
        }

        function removeFile() {
            currentFile = null;
            currentResume = null;
            document.getElementById('filePreview').classList.remove('active');
            document.getElementById('fileInput').value = '';
            document.getElementById('analyzeBtn').disabled = true;
        }

        async function uploadResume(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                const response = await fetch(`${API_URL}/resume/upload`, {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success && data.text) {
                    currentResume = {
                        text: data.text,
                        fileName: data.filename,
                        fileType: data.file_type
                    };
                    console.log('‚úÖ Resume uploaded successfully:', data.text.length, 'characters');
                    return true;
                } else {
                    console.error('‚ùå Upload failed:', data.error || 'No text extracted');
                    currentResume = null;
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Upload error:', error);
                currentResume = null;
                return false;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // RAG Analysis
        async function analyzeWithRAG() {
            if (!currentResume || !currentResume.text) {
                alert('Resume not properly uploaded. Please try uploading again.');
                console.error('‚ùå currentResume:', currentResume);
                return;
            }

            const jobDescription = document.getElementById('jobDescriptionText').value.trim();
            
            if (!jobDescription) {
                if (!confirm('No job description provided. Continue with resume analysis only?')) {
                    return;
                }
            }

            // Save job description with resume for persistence
            currentResume.jobDescription = jobDescription;
            saveToStorage();

            closeUploadModal();
            showWelcome(false);
            
            addMessage('user', `Uploaded resume: ${currentFile.name}${jobDescription ? ' with job description' : ''}`);
            showTypingIndicator();

            console.log('üì§ Sending to RAG:', {
                resume_length: currentResume.text.length,
                jd_length: jobDescription.length,
                has_resume: !!currentResume.text,
                has_jd: !!jobDescription
            });
            
            try {
                const response = await fetch(`${API_URL}/rag/analyze`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_text: currentResume.text,
                        job_description: jobDescription || ''
                    })
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.success) {
                    const result = data.result;
                    let message = `<p><strong>‚úÖ RAG Analysis Complete!</strong></p>`;
                    message += `<p>üìä Created ${result.rag_ingestion.chunks_created} semantic chunks in vector database</p>`;
                    
                    if (result.ai_suggestions && result.ai_suggestions.length > 0) {
                        message += `<div class="suggestion-box">`;
                        message += `<h4>üí° AI Improvement Suggestions:</h4>`;
                        message += `<ol class="suggestion-list">`;
                        result.ai_suggestions.slice(0, 5).forEach((suggestion, index) => {
                            // Clean and format each suggestion
                            const formatted = formatMarkdown(suggestion);
                            message += `<li><span class="suggestion-number">${index + 1}</span><span class="suggestion-text">${formatted}</span></li>`;
                        });
                        message += `</ol></div>`;
                    }
                    
                    addMessage('ai', message);
                    
                    // Show suggestion chips
                    setTimeout(() => {
                        addSuggestionChips();
                    }, 500);
                } else {
                    addMessage('ai', `‚ùå Error: ${data.error || 'Unknown error'}. Make sure GEMINI_API_KEY is configured in .env file.`);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('ai', `‚ùå Error: ${error.message}`);
            }
        }

        function addSuggestionChips() {
            let message = '<div class="suggestion-box">';
            
            // Quick Actions
            message += '<h4>üí° Quick Actions:</h4><div class="suggestion-chips">';
            const quickActions = [
                "Emphasize my technical skills",
                "Add quantifiable metrics",
                "Make it ATS-friendly"
            ];
            quickActions.forEach(s => {
                message += `<span class="suggestion-chip" onclick="useExample('${s}')">${s}</span>`;
            });
            message += '</div>';
            
            // Agent Tools
            message += '<h4 style="margin-top:1rem;">ü§ñ Agent Tools (All 4 Tools):</h4><div class="suggestion-chips">';
            message += `<span class="suggestion-chip tool-chip" onclick="runAgentTool('analyze-job')">üìã Analyze Job (Tool 1)</span>`;
            message += `<span class="suggestion-chip tool-chip" onclick="runAgentTool('analyze-resume')">üìÑ Analyze Resume (Tool 2)</span>`;
            message += `<span class="suggestion-chip tool-chip" onclick="runAgentTool('create-strategy')">üß† Create Strategy (Tool 3)</span>`;
            message += `<span class="suggestion-chip tool-chip generate" onclick="useExample('Generate tailored resume')">‚ú® Generate Resume (Tool 4)</span>`;
            message += '</div>';
            
            // Full Pipeline
            message += '<h4 style="margin-top:1rem;">üöÄ Full Pipeline:</h4><div class="suggestion-chips">';
            message += `<span class="suggestion-chip tool-chip full-pipeline" onclick="runFullPipeline()">üî• Run All 4 Tools & Generate LaTeX</span>`;
            message += '</div>';
            
            message += '</div>';
            
            addMessage('ai', message);
        }

        // Run individual agent tool
        async function runAgentTool(tool) {
            if (!currentResume || !currentResume.text) {
                addMessage('ai', '<p>‚ùå Please upload a resume first.</p>');
                return;
            }
            
            const toolNames = {
                'analyze-job': 'Job Analyzer (Tool 1)',
                'analyze-resume': 'Resume Analyzer (Tool 2)',
                'create-strategy': 'Strategy Creator (Tool 3)'
            };
            
            showWelcome(false);
            addMessage('user', `Run ${toolNames[tool]}`);
            showTypingIndicator();
            
            try {
                let body = { resume_text: currentResume.text };
                if (tool === 'analyze-job' || tool === 'create-strategy') {
                    if (!currentResume.jobDescription) {
                        hideTypingIndicator();
                        addMessage('ai', '<p>‚ùå Job description required. Upload resume with JD first.</p>');
                        return;
                    }
                    body.job_description = currentResume.jobDescription;
                }
                
                const response = await fetch(`${API_URL}/agent/${tool}`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.success) {
                    let message = `<div class="agent-result">`;
                    message += `<h3>‚úÖ ${data.tool}</h3>`;
                    
                    if (tool === 'analyze-job' && data.analysis) {
                        message += formatJobAnalysis(data.analysis);
                    } else if (tool === 'analyze-resume' && data.analysis) {
                        message += formatResumeAnalysis(data.analysis);
                    } else if (tool === 'create-strategy') {
                        message += formatStrategy(data.strategy);
                    }
                    
                    message += `</div>`;
                    addMessage('ai', message);
                } else {
                    addMessage('ai', `<p>‚ùå Error: ${data.error}</p>`);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('ai', `<p>‚ùå Error: ${error.message}</p>`);
            }
        }

        // Format job analysis output
        function formatJobAnalysis(analysis) {
            let html = '<div class="analysis-content">';
            
            if (analysis.required_skills?.length) {
                html += `<p><strong>üéØ Required Skills:</strong></p><ul>`;
                analysis.required_skills.forEach(s => html += `<li>${s}</li>`);
                html += '</ul>';
            }
            
            if (analysis.experience_level) {
                html += `<p><strong>üìä Experience Level:</strong> ${analysis.experience_level}</p>`;
            }
            
            if (analysis.key_responsibilities?.length) {
                html += `<p><strong>üìã Key Responsibilities:</strong></p><ul>`;
                analysis.key_responsibilities.slice(0, 5).forEach(r => html += `<li>${r}</li>`);
                html += '</ul>';
            }
            
            if (analysis.important_keywords?.length) {
                html += `<p><strong>üîë ATS Keywords:</strong> ${analysis.important_keywords.join(', ')}</p>`;
            }
            
            html += '</div>';
            return html;
        }

        // Format resume analysis output
        function formatResumeAnalysis(analysis) {
            let html = '<div class="analysis-content">';
            
            if (analysis.name) {
                html += `<p><strong>üë§ Name:</strong> ${analysis.name}</p>`;
            }
            
            if (analysis.skills?.length) {
                html += `<p><strong>üíº Skills (${analysis.skills.length}):</strong> ${analysis.skills.slice(0, 10).join(', ')}${analysis.skills.length > 10 ? '...' : ''}</p>`;
            }
            
            if (analysis.experience?.length) {
                html += `<p><strong>üíº Experience (${analysis.experience.length} positions):</strong></p><ul>`;
                analysis.experience.slice(0, 3).forEach(exp => {
                    html += `<li><strong>${exp.title}</strong> at ${exp.company} (${exp.duration})</li>`;
                });
                html += '</ul>';
            }
            
            if (analysis.education?.length) {
                html += `<p><strong>üéì Education:</strong></p><ul>`;
                analysis.education.forEach(edu => {
                    html += `<li>${edu.degree} - ${edu.institution}</li>`;
                });
                html += '</ul>';
            }
            
            const contact = analysis.contact_info || {};
            if (contact.github || contact.portfolio) {
                html += `<p><strong>üîó Links:</strong> `;
                if (contact.github) html += `<a href="${contact.github}" target="_blank">GitHub</a> `;
                if (contact.portfolio) html += `<a href="${contact.portfolio}" target="_blank">Portfolio</a>`;
                html += '</p>';
            }
            
            html += '</div>';
            return html;
        }

        // Format strategy output
        function formatStrategy(strategy) {
            let html = '<div class="strategy-content">';
            
            html += `<p><strong>üìä Match Score:</strong> <span class="match-score">${strategy.overall_match_score || 'N/A'}/100</span></p>`;
            
            if (strategy.match_summary) {
                html += `<p><strong>üìù Summary:</strong> ${strategy.match_summary}</p>`;
            }
            
            if (strategy.strong_matches?.length) {
                html += `<p><strong>‚úÖ Strong Matches (${strategy.strong_matches.length}):</strong></p><ul>`;
                strategy.strong_matches.slice(0, 3).forEach(m => {
                    html += `<li><strong>${m.skill_or_experience}</strong>: ${m.strategy}</li>`;
                });
                html += '</ul>';
            }
            
            if (strategy.gaps?.length) {
                html += `<p><strong>‚ö†Ô∏è Gaps to Address (${strategy.gaps.length}):</strong></p><ul>`;
                strategy.gaps.slice(0, 3).forEach(g => {
                    html += `<li><strong>${g.missing}</strong> (${g.severity}): ${g.mitigation}</li>`;
                });
                html += '</ul>';
            }
            
            if (strategy.keywords_to_add?.length) {
                html += `<p><strong>üîë Keywords to Add:</strong> ${strategy.keywords_to_add.join(', ')}</p>`;
            }
            
            if (strategy.specific_actions?.length) {
                html += `<p><strong>üìã Action Items:</strong></p><ol>`;
                strategy.specific_actions.slice(0, 5).forEach(a => html += `<li>${a}</li>`);
                html += '</ol>';
            }
            
            html += '</div>';
            return html;
        }

        // Run full 4-tool pipeline
        async function runFullPipeline() {
            if (!currentResume || !currentResume.text) {
                addMessage('ai', '<p>‚ùå Please upload a resume first.</p>');
                return;
            }
            
            if (!currentResume.jobDescription) {
                addMessage('ai', '<p>‚ùå Job description required. Upload resume with JD first.</p>');
                return;
            }
            
            showWelcome(false);
            addMessage('user', 'üöÄ Run Full 4-Tool Pipeline');
            showTypingIndicator();
            addMessage('ai', '<p>üîÑ Running all 4 tools... This may take 1-2 minutes.</p>');
            
            try {
                const response = await fetch(`${API_URL}/agent/full-pipeline`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_text: currentResume.text,
                        job_description: currentResume.jobDescription
                    })
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.success) {
                    // Store LaTeX
                    window.generatedLatex = data.latex;
                    window.latexFilename = 'tailored_resume.tex';
                    
                    let message = '<div class="pipeline-result">';
                    message += '<h3>üéâ Full Pipeline Complete!</h3>';
                    message += `<p><strong>Tools Used:</strong> ${data.tools_used.join(' ‚Üí ')}</p>`;
                    
                    // Strategy summary
                    if (data.strategy) {
                        message += `<p><strong>Match Score:</strong> <span class="match-score">${data.strategy.overall_match_score || 'N/A'}/100</span></p>`;
                    }
                    
                    // Download buttons
                    message += `<div class="download-section">`;
                    message += `<button class="download-btn" onclick="downloadLatex()"><i class="fas fa-download"></i> Download .tex File</button>`;
                    message += `<button class="view-btn" onclick="viewLatex()"><i class="fas fa-code"></i> View LaTeX</button>`;
                    message += `</div>`;
                    
                    message += `<p class="hint">üí° Open in <a href="https://overleaf.com" target="_blank">Overleaf</a> to compile PDF</p>`;
                    message += '</div>';
                    
                    addMessage('ai', message);
                } else {
                    addMessage('ai', `<p>‚ùå Error: ${data.error}</p>`);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('ai', `<p>‚ùå Error: ${error.message}</p>`);
            }
        }

        // Convert markdown to HTML
        function formatMarkdown(text) {
            if (!text) return '';
            
            // Convert **bold** to <strong>
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Convert *italic* to <em>
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');
            // Convert `code` to <code>
            text = text.replace(/`(.+?)`/g, '<code>$1</code>');
            // Convert numbered lists (1. item)
            text = text.replace(/^(\d+)\.\s+(.+)$/gm, '<li class="numbered">$2</li>');
            // Convert bullet points (- item or * item)
            text = text.replace(/^[\-\*]\s+(.+)$/gm, '<li>$1</li>');
            // Wrap consecutive <li> in <ul>
            text = text.replace(/(<li[^>]*>.*?<\/li>\n?)+/gs, '<ul>$&</ul>');
            // Convert line breaks
            text = text.replace(/\n\n/g, '</p><p>');
            text = text.replace(/\n/g, '<br>');
            
            return text;
        }

        // Messages
        function addMessage(type, content) {
            // Save to history and localStorage
            chatHistory.push({ type, content, timestamp: Date.now() });
            saveToStorage();
            
            // Add to DOM
            addMessageToDOM(type, content, false);
        }

        function addMessageToDOM(type, content, save = true) {
            const container = document.getElementById('messagesContainer');
            container.style.display = 'flex';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            if (type === 'ai') {
                avatar.innerHTML = '<i class="fas fa-robot"></i>';
                avatar.style.background = 'var(--color-primary)';
                avatar.style.color = 'white';
            } else {
                const initials = currentUser ? currentUser.full_name?.split(' ')[0]?.[0]?.toUpperCase() || 'U' : 'U';
                avatar.textContent = initials;
                avatar.style.background = 'var(--color-user-bg)';
                avatar.style.color = 'white';
            }
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            // Apply markdown formatting for AI messages
            contentDiv.innerHTML = type === 'ai' ? formatMarkdown(content) : content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            container.insertBefore(messageDiv, document.getElementById('typingIndicator'));
            
            container.scrollTop = container.scrollHeight;
            messageCount++;
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').classList.add('active');
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('active');
        }

        function showWelcome(show) {
            document.getElementById('welcomeState').style.display = show ? 'flex' : 'none';
            document.getElementById('messagesContainer').style.display = show ? 'none' : 'flex';
        }

        // Chat
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            showWelcome(false);
            addMessage('user', message);
            input.value = '';
            adjustTextareaHeight();
            updateSendButton();
            
            // Check if it's generate resume command
            if (/generate.*tailored.*resume|generate.*resume|create.*resume/i.test(message)) {
                await generateTailoredResume();
                return;
            }
            
            // Check if it's an instruction
            const isInstruction = /emphasize|highlight|add|rewrite|modify|improve|tailor|make|create|write|quantify|focus on/i.test(message);
            
            if (isInstruction && currentResume) {
                await tailorWithInstruction(message);
            } else {
                await chatWithRAG(message);
            }
        }

        // Generate complete tailored resume in LaTeX
        async function generateTailoredResume() {
            if (!currentResume || !currentResume.text) {
                addMessage('ai', `<p>‚ùå Please upload a resume first before generating.</p>`);
                return;
            }
            
            if (!currentResume.jobDescription) {
                addMessage('ai', `<p>‚ùå Job description required for tailored resume. Please upload your resume with a job description.</p>`);
                return;
            }
            
            showTypingIndicator();
            addMessage('ai', `<p>üîÑ Generating your tailored LaTeX resume... This may take 30-60 seconds.</p>`);
            
            try {
                const response = await fetch(`${API_URL}/resume/generate-tailored`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_text: currentResume.text,
                        job_description: currentResume.jobDescription
                    })
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.success && data.latex) {
                    // Store LaTeX for download
                    window.generatedLatex = data.latex;
                    window.latexFilename = data.filename || 'tailored_resume.tex';
                    
                    // Show strategy summary
                    let message = `<div class="latex-result">`;
                    message += `<h3>‚úÖ Tailored Resume Generated!</h3>`;
                    
                    if (data.strategy) {
                        message += `<p><strong>Match Score:</strong> ${data.strategy.overall_match_score || 'N/A'}/100</p>`;
                        if (data.strategy.key_modifications) {
                            message += `<p><strong>Key Changes:</strong></p><ul>`;
                            data.strategy.key_modifications.slice(0, 3).forEach(mod => {
                                message += `<li>${mod}</li>`;
                            });
                            message += `</ul>`;
                        }
                    }
                    
                    // Download button
                    message += `<div class="download-section">`;
                    message += `<button class="download-btn" onclick="downloadLatex()"><i class="fas fa-download"></i> Download .tex File</button>`;
                    message += `<button class="view-btn" onclick="viewLatex()"><i class="fas fa-code"></i> View LaTeX Code</button>`;
                    message += `</div>`;
                    
                    message += `<p class="hint">üí° Open the .tex file in <a href="https://overleaf.com" target="_blank">Overleaf</a> to compile as PDF</p>`;
                    message += `</div>`;
                    
                    addMessage('ai', message);
                } else {
                    addMessage('ai', `<p>‚ùå Error: ${data.error || 'Failed to generate resume'}</p>`);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('ai', `<p>‚ùå Error: ${error.message}</p>`);
            }
        }

        // Download LaTeX file
        function downloadLatex() {
            if (!window.generatedLatex) {
                alert('No LaTeX content available. Please generate a resume first.');
                return;
            }
            
            const blob = new Blob([window.generatedLatex], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = window.latexFilename || 'tailored_resume.tex';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('üì• LaTeX file downloaded!', 'success');
        }

        // View LaTeX code in chat
        function viewLatex() {
            if (!window.generatedLatex) {
                alert('No LaTeX content available.');
                return;
            }
            
            // Show LaTeX in a code block
            const escapedLatex = window.generatedLatex
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            
            let message = `<div class="latex-code-container">`;
            message += `<div class="code-header"><span>LaTeX Code</span><button onclick="copyLatex()"><i class="fas fa-copy"></i> Copy</button></div>`;
            message += `<pre class="latex-code"><code>${escapedLatex}</code></pre>`;
            message += `</div>`;
            
            addMessage('ai', message);
        }

        // Copy LaTeX to clipboard
        function copyLatex() {
            if (!window.generatedLatex) return;
            
            navigator.clipboard.writeText(window.generatedLatex).then(() => {
                showNotification('üìã LaTeX copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
            });
        }

        async function tailorWithInstruction(instruction) {
            showTypingIndicator();
            
            try {
                const response = await fetch(`${API_URL}/rag/tailor`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ instruction })
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.success && data.result) {
                    const content = data.result.tailored_content || data.result.message || 'Content generated successfully';
                    const formatted = formatMarkdown(content);
                    addMessage('ai', formatted);
                } else {
                    const errorMsg = data.error || data.result?.error || data.result?.message || 'Vector store not found. Please upload and analyze a resume first.';
                    addMessage('ai', `<p>‚ùå ${errorMsg}</p>`);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('ai', `<p>‚ùå Error: ${error.message}</p>`);
            }
        }

        async function chatWithRAG(message) {
            showTypingIndicator();
            
            try {
                const response = await fetch(`${API_URL}/rag/chat`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                
                const data = await response.json();
                hideTypingIndicator();
                
                if (data.success && data.response) {
                    const formatted = formatMarkdown(data.response);
                    addMessage('ai', formatted);
                } else {
                    const errorMsg = data.error || 'Unable to process your request. Make sure you\'ve uploaded a resume first.';
                    addMessage('ai', `<p>‚ùå ${errorMsg}</p>`);
                }
            } catch (error) {
                hideTypingIndicator();
                addMessage('ai', `<p>‚ùå Error: ${error.message}</p>`);
            }
        }

        function useExample(text) {
            document.getElementById('chatInput').value = text;
            updateSendButton();
            showWelcome(false);
        }

        function startNewChat() {
            if (messageCount > 0 && !confirm('Start a new chat? Current conversation will be cleared.')) {
                return;
            }
            
            // Clear chat history but keep resume
            chatHistory = [];
            document.getElementById('messagesContainer').innerHTML = '<div class="typing-indicator" id="typingIndicator"><div class="message-avatar" style="background: var(--color-primary); color: white;"><i class="fas fa-robot"></i></div><div class="typing-dots"><span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span></div></div>';
            showWelcome(true);
            messageCount = 0;
            
            // Save updated state (keeps resume, clears chat)
            saveToStorage();
        }

        // Input handling
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function adjustTextareaHeight() {
            const textarea = document.getElementById('chatInput');
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
        }

        function updateSendButton() {
            const input = document.getElementById('chatInput');
            const btn = document.getElementById('sendBtn');
            btn.disabled = input.value.trim() === '';
        }
    </script>
</body>
</html>

